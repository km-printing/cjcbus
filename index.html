<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CJC Bus Arrival Timings</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #ffffff;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #00e676;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #333;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #1f1f1f;
      color: #00e676;
    }
    tr:nth-child(even) {
      background-color: #1e1e1e;
    }
    .collapsible {
      background-color: #1f1f1f;
      color: #00e676;
      cursor: pointer;
      padding: 12px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 16px;
      margin-bottom: 5px;
    }
    .active, .collapsible:hover {
      background-color: #333;
    }
    .content {
      padding: 0 15px;
      display: none;
      overflow: hidden;
      background-color: #1a1a1a;
      border: 1px solid #333;
      margin-bottom: 20px;
    }
    .customise-section {
      margin-top: 20px;
      text-align: left;
    }
    .customise-section label {
      display: block;
      margin: 5px 0;
    }
    .btn {
      background-color: #00e676;
      color: #121212;
      border: none;
      padding: 10px 15px;
      margin: 10px 0;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
    }
    .btn:hover {
      background-color: #00c853;
    }
  </style>
</head>
<body>
  <h1>CJC Bus Arrival Timings</h1>
  <table id="busTable">
    <thead>
      <tr>
        <th>Bus</th>
        <th>College Side</th>
        <th>Opposite Side</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button type="button" class="collapsible">➕ Customise your view</button>
  <div class="content">
    <div class="customise-section">
      <h3>Choose Buses</h3>
      <div id="bus-options">Loading...</div>
      <h3>Choose Sides</h3>
      <label><input type="checkbox" id="side-college" checked> College Side</label>
      <label><input type="checkbox" id="side-opposite" checked> Opposite Side</label>
      <button class="btn" onclick="applyCustomisation()">Apply</button>
      <button class="btn" onclick="saveToHome()">Save to Home Screen</button>
    </div>
  </div>

  <script>
    const stops = {
      college: "51099",
      opposite: "51091"
    };

    let busesData = { college: {}, opposite: {} };

    async function fetchBusData(stopId, key) {
      const response = await fetch(`https://arrivelah2.busrouter.sg/?id=${stopId}`);
      const data = await response.json();
      busesData[key] = {};
      data.services.forEach(service => {
        busesData[key][service.no] = [
          service.next.time ? new Date(service.next.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "N/A",
          service.subsequent.time ? new Date(service.subsequent.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "N/A"
        ];
      });
    }

    async function loadBusData() {
      await fetchBusData(stops.college, "college");
      await fetchBusData(stops.opposite, "opposite");
      renderTable();
      renderBusOptions();
    }

    function renderTable() {
      const tbody = document.querySelector("#busTable tbody");
      tbody.innerHTML = "";

      const urlParams = new URLSearchParams(window.location.search);
      const selectedBuses = urlParams.get("buses") ? urlParams.get("buses").split(",") : null;
      const showCollege = urlParams.get("college") !== "false";
      const showOpposite = urlParams.get("opposite") !== "false";

      const allBuses = new Set([...Object.keys(busesData.college), ...Object.keys(busesData.opposite)]);
      allBuses.forEach(bus => {
        if (selectedBuses && !selectedBuses.includes(bus)) return;
        const row = document.createElement("tr");

        const busCell = document.createElement("td");
        busCell.textContent = bus;
        row.appendChild(busCell);

        const collegeCell = document.createElement("td");
        collegeCell.textContent = showCollege && busesData.college[bus] ? busesData.college[bus].join(" / ") : "-";
        row.appendChild(collegeCell);

        const oppositeCell = document.createElement("td");
        oppositeCell.textContent = showOpposite && busesData.opposite[bus] ? busesData.opposite[bus].join(" / ") : "-";
        row.appendChild(oppositeCell);

        tbody.appendChild(row);
      });
    }

    function renderBusOptions() {
      const container = document.getElementById("bus-options");
      container.innerHTML = "";
      const allBuses = new Set([...Object.keys(busesData.college), ...Object.keys(busesData.opposite)]);
      allBuses.forEach(bus => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${bus}" checked> Bus ${bus}`;
        container.appendChild(label);
      });
    }

    function applyCustomisation() {
      const selectedBuses = [...document.querySelectorAll("#bus-options input:checked")].map(cb => cb.value);
      const showCollege = document.getElementById("side-college").checked;
      const showOpposite = document.getElementById("side-opposite").checked;

      const params = new URLSearchParams();
      if (selectedBuses.length > 0) params.set("buses", selectedBuses.join(","));
      params.set("college", showCollege);
      params.set("opposite", showOpposite);

      window.location.search = params.toString();
    }

    function saveToHome() {
      alert("To save this page to your home screen:\n- On iPhone Safari: Tap Share → Add to Home Screen\n- On Android Chrome: Tap Menu → Add to Home Screen");
    }

    // Collapsible logic
    document.querySelector(".collapsible").addEventListener("click", function() {
      this.classList.toggle("active");
      const content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
        this.textContent = "➕ Customise your view";
      } else {
        content.style.display = "block";
        this.textContent = "➖ Customise your view";
      }
    });

    loadBusData();
    setInterval(loadBusData, 30000);
  </script>
</body>
</html>
